<!DOCTYPE html>
<html lang="en">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>

    <title>bendoerr.me</title>


    <link href="../css/bootstrap.css" rel="stylesheet"></link>
    <link href="../css/responsive.css" rel="stylesheet">
    <link href="../css/site.css" rel="stylesheet">
    <link href="../css/site-responsive.css" rel="stylesheet">
    <link href="../css/syntax.css" rel="stylesheet">
    <link href="../css/lightbox.css" rel="stylesheet"></link>
  </head>

  <body>

    <!-- ================================================================== -->
    <!-- = Top Navigation ================================================= -->
    <!-- ================================================================== -->
    <div id="site-navigation" class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <ul class="nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../about.html">About</a></li>
            <li><a href="../posts.html">Blog</a></li>
            <li><a href="../contact.html">Contact</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- = Brand Header =================================================== -->
    <!-- ================================================================== -->
    <header id="page-header" class="site-header">
      <div class="container">
        <hgroup class>
          <h1>bendoerr.me</h1>
          <small>I saw where a blog was not, and said, no. This will not do.</small>
        </hgroup>
      </div>
    </header>

    <div class="container">

      
        <!-- ============================================================== -->
        <!-- = Article Post =============================================== -->
        <!-- ============================================================== -->
        <article>
          <header>
            <h1><a href="../posts/2012-10-14-activemq-jmx-purge.html">Purge ActiveMQ Queues</a></h1>
            <p class="category pull-right"><span class="label label-category Java"><a href="../posts/category/Java.html">Java</a></span></p>
            <p><i class="icon-calendar"></i> <time datatime="2012-10-14" pubdate>Sunday, October 14, 2012</time></p>
          </header>

          <p>Whether for testing or some edge case sometimes you just need to clear out messages that have been building up. Here is an example of how you can clean all of a brokers queues using facilities exposed by <a href="http://en.wikipedia.org/wiki/Java_Management_Extensions" title="Wikipedia: Java Management Extensions">JMX</a> in ActiveMQ.</p>
<!--MORE-->

<p>The JMX url that you use to connect will depend on how you have <a href="http://activemq.apache.org/jmx.html" title="ActiveMQ JMX Feature">configured</a> your ActiveMQ broker. I was running an embedded broker in a <a href="http://karaf.apache.org/" title="Karaf OSGi Runtime">Karaf</a> OSGi container that was configured to use JMX but not create a new JMX connection. It took me a minute or two to figure out the correct JMX url of <code>service:jmx:rmi://0.0.0.0:44444/jndi/rmi://0.0.0.0:1099/jmxrmi</code> so I share it here for prosperity.</p>
<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;broker</span><span class="ot"> xmlns=</span><span class="st">&quot;http://activemq.org/config/1.0&quot;</span><span class="ot"> brokerName=</span><span class="st">&quot;mqbroker&quot;</span><span class="ot"> useJmx=</span><span class="st">&quot;true&quot;</span><span class="kw">&gt;</span>
  ...
  <span class="kw">&lt;managementContext&gt;</span>
     <span class="kw">&lt;managementContext</span><span class="ot"> createConnector=</span><span class="st">&quot;false&quot;</span><span class="kw">/&gt;</span>
  <span class="kw">&lt;/managementContext&gt;</span>
  ...
<span class="kw">&lt;/broker&gt;</span></code></pre>
<p>The first thing is to create a <a href="http://docs.oracle.com/javase/7/docs/api/javax/management/MBeanServerConnection.html" title="Interface MBeanServerConnection">MBeanServerConnection</a> which we can then use to look up our <a href="http://activemq.apache.org/maven/5.7.0/activemq-core/apidocs/org/apache/activemq/broker/jmx/BrokerViewMBean.html" title="Interface BrokerViewMBean">BrokerViewMBean</a> and <a href="http://activemq.apache.org/maven/5.7.0/activemq-core/apidocs/org/apache/activemq/broker/jmx/QueueViewMBean.html" title="Interface QueueViewMBean">QueueViewMBean</a> by creating a connection from the <a href="http://docs.oracle.com/javase/7/docs/api/javax/management/remote/JMXConnectorFactory.html" title="Class JMXConnectorFactory">JMXConnectorFactory</a>.</p>
<pre class="sourceCode java"><code class="sourceCode java">JMXServiceURL url = <span class="kw">new</span> JMXServiceURL(<span class="st">&quot;service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi&quot;</span>);
JMXConnector jmxc = <span class="kw">null</span>;
<span class="kw">try</span> {
    jmxc = JMXConnectorFactory.<span class="fu">connect</span>(url))
    MBeanServerConnection conn = jmxc.<span class="fu">getMBeanServerConnection</span>();</code></pre>
<p>Now that you have the connection you can query it for the <code>BrokerViewMBean</code>.</p>
<pre class="sourceCode java"><code class="sourceCode java">    ObjectName jmxBrokerName = <span class="kw">new</span> ObjectName(<span class="st">&quot;org.apache.activemq:BrokerName=mqbroker,Type=Broker&quot;</span>);
    BrokerViewMBean brokerView =
            MBeanServerInvocationHandler.<span class="fu">newProxyInstance</span>(conn, jmxBrokerName, BrokerViewMBean.<span class="fu">class</span>, <span class="kw">true</span>);</code></pre>
<p>From the broker view you can get all of the queue names and then query those and finally purge them.</p>
<pre class="sourceCode java"><code class="sourceCode java">    <span class="kw">for</span> (ObjectName jmxQueueName : mbean.<span class="fu">getQueues</span>()) {
        QueueViewMBean queueView =
            MBeanServerInvocationHandler.<span class="fu">newProxyInstance</span>(conn, jmxQueueName, QueueViewMBean.<span class="fu">class</span>, <span class="kw">true</span>);
        queueView.<span class="fu">purge</span>();
    }</code></pre>
<p>The donâ€™t forget to clean up.</p>
<pre class="sourceCode java"><code class="sourceCode java">} <span class="kw">finally</span> {
    <span class="kw">if</span> (jmxc != <span class="kw">null</span>)
        jmxc.<span class="fu">close</span>();
}</code></pre>
<p>There is a bunch more that is exposed via these MBeans that is useful in monitoring your broker as well. I suggest taking a look at the JavaDocs if that interests you.</p>

          <footer>
            <p class="tags pull-right"><i class="icon-tags"></i> <a href="../posts/tag/activemq.html">activemq</a>, <a href="../posts/tag/jxm.html">jxm</a>, <a href="../posts/tag/karaf.html">karaf</a></p>
            <p class="signoff"><i class="icon-pencil"></i> Ben Doerr</p>

            <p class="social">
              <div data-href="/posts/2012-10-14-activemq-jmx-purge.html" class="g-plus" data-action="share" data-annotation="bubble"></div>

              <a data-url="/posts/2012-10-14-activemq-jmx-purge.html" data-text="Post Title" data-via="bendoerr" href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
            </p>

            <div id="comments" class="comments">
              <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_shortname = 'bendoerrme';
                    var disqus_identifier = '/posts/2012-10-14-activemq-jmx-purge.html';
                    var disqus_title = 'Purge ActiveMQ Queues';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
          </footer>
        </article>


    </div>

    <!-- ================================================================== -->
    <!-- = Site Footer ==================================================== -->
    <!-- ================================================================== -->
    <footer>
      <div class="container">

        <div class="row visible-desktop">
          <section id="information-desktop" class="span8">
            <h4><i class="icon-legal"></i> Information &amp; Copyright</h4>
            <p>Powered by Hakyll, Bootstrap, Github, and Hover. Syntax
            highlighting by Pandoc. Icons by Font Awesome. Tagline inspired by
            Penny Arcade.</p>

            <p>
              <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
                <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png"></img>
              </a>
              Except where otherwise noted, content on
              <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">bendoerr.me</span>
              by
              <a xmlns:cc="http://creativecommons.org/ns#" href="http://bendoerr.me" property="cc:attributionName" rel="cc:attributionURL">
                Benjamin R. Doerr
              </a>
              is licensed under a
              <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
                Creative Commons Attribution-ShareAlike 3.0 Unported License
              </a>.
            </p>

            <p><a href="https://github.com/bendoerr/bendoerr.me"><i class="icon-list-alt"></i> Get the source</a></p>
          </section>

          <section id="social-follow" class="span4">
            <h4><i class="icon-globe"></i> Around the web</h4>
            <ul class="unstyled">
              <li>
                <a class="btn btn-inverse btn-large" href="#">
                  <i class="icon-github"></i> Github
                </a>
              </li>
              <li>
                <a class="btn btn-inverse btn-large" href="#">
                  <i class="icon-twitter"></i> Twitter
                </a>
              </li>
              <li>
                <a class="btn btn-inverse btn-large" href="#">
                  <i class="icon-google-plus"></i> Google+
                </a>
              </li>
            </ul>
          </section>
        </div>

        <div class="row hidden-desktop">
          <section id="information-phone" class="span12">
            <h4><i class="icon-legal"></i> Information &amp; Copyright</h4>
            <p>Powered by Hakyll, Bootstrap, Github, and Hover. Syntax
            highlighting by Pandoc. Icons by Font Awesome. Tagline inspired by
            Penny Arcade.</p>

            <p>
              <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
                <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png"></img>
              </a>
              Except where otherwise noted, content on
              <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">bendoerr.me</span>
              by
              <a xmlns:cc="http://creativecommons.org/ns#" href="http://bendoerr.me" property="cc:attributionName" rel="cc:attributionURL">
                Benjamin R. Doerr
              </a>
              is licensed under a
              <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
                Creative Commons Attribution-ShareAlike 3.0 Unported License
              </a>.
            </p>

            <p><a href="https://github.com/bendoerr/bendoerr.me"><i class="icon-list-alt"></i> Get the source</a></p>
          </section>
        </div>

      </div>
    </footer>


    <!--<script src="http://code.jquery.com/jquery-latest.js"></script>-->
    <script src="../js/jquery-1.7.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/lightbox.js"></script>

    <!-- Google+ Async Share Script -->
    <script type="text/javascript">
      (function () {
       var po = document.createElement('script');
       po.type = 'text/javascript';
       po.async = true;
       po.src = 'https://apis.google.com/js/plusone.js';
       var s = document.getElementsByTagName('script')[0];
       s.parentNode.insertBefore(po, s);
       })();
     </script>

     <!-- Twitter Async Share Script -->
     <script>
       !function (d, s, id) {
         var js, fjs = d.getElementsByTagName(s)[0];
         if (!d.getElementById(id)) {
           js = d.createElement(s);
           js.id = id;
           js.src = "https://platform.twitter.com/widgets.js";
           fjs.parentNode.insertBefore(js, fjs);
         }
       }(document, "script", "twitter-wjs");
     </script>

    <!-- Disqus Comment Counts -->
    <script type="text/javascript">
      var disqus_developer = 1; // developer mode is on
      var disqus_shortname = 'bendoerrme';
      var disqus_url = 'http://bendoerr.me/this-posts-url';
      var disqus_identifier = 'this-posts-url';
      var disqus_title = 'Post Title';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
       var s = document.createElement('script'); s.async = true;
       s.type = 'text/javascript';
       s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
       (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>
  </body>
</html>
